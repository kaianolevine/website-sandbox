<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Deejay Set Collection</title>
  </head>
  <body>
    <h1>Deejay Set Collection</h1>

    <p>
      Data source:
      <a href="/site_data/deejay_set_collection.json" target="_blank" rel="noopener">deejay_set_collection.json</a>
    </p>

    <label for="search">Search:</label>
    <input id="search" type="search" placeholder="Type to filter…" style="min-width: 280px;" />
    <div id="status" style="margin-top: 8px; color: #666;"></div>

    <div id="meta" style="margin-top: 12px;"></div>
    <div id="content" style="margin-top: 16px;"></div>

    <script>
      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function normalizeForSearch(str) {
        return String(str || "").toLowerCase();
      }

      function renderCollection(data, query) {
        const q = normalizeForSearch(query);
        const content = document.getElementById("content");
        const status = document.getElementById("status");

        const foldersRaw = Array.isArray(data?.folders) ? data.folders : [];

        function folderSortKey(name) {
          const n = String(name || "");
          const lower = n.toLowerCase();
          if (lower === "summary") return { group: 0, year: -1, label: lower };

          // Year-like folder (e.g., "2026")
          const yearMatch = lower.match(/^\d{4}$/);
          if (yearMatch) return { group: 1, year: Number(lower), label: lower };

          return { group: 2, year: -1, label: lower };
        }

        const folders = [...foldersRaw].sort((a, b) => {
          const ka = folderSortKey(a?.name);
          const kb = folderSortKey(b?.name);

          if (ka.group !== kb.group) return ka.group - kb.group;

          // For years: descending
          if (ka.group === 1 && kb.group === 1) return kb.year - ka.year;

          // Otherwise: ascending alpha
          return ka.label.localeCompare(kb.label);
        });

        // Determine which folder should be open by default.
        // Summary is always open; also open the first year folder (most recent) when present.
        const firstYearFolderName = folders.find((f) => String(f?.name || "").match(/^\d{4}$/))?.name;

        let totalMatched = 0;

        const folderHtml = folders
          .map((folder) => {
            const folderName = folder?.name || "(Unnamed folder)";
            const items = Array.isArray(folder?.items) ? folder.items : [];

            const filtered = items.filter((it) => {
              if (!q) return true;
              const haystack = [
                it?.date,
                it?.title,
                it?.label,
                it?.url,
                folderName,
              ]
                .filter(Boolean)
                .map(normalizeForSearch)
                .join(" | ");
              return haystack.includes(q);
            });

            if (q && filtered.length === 0) return "";

            totalMatched += filtered.length;

            const list = filtered
              .map((it) => {
                const label = it?.label || it?.title || "(untitled)";
                const url = it?.url || "#";
                const date = it?.date
                  ? `<span style=\"font-family: monospace;\">${escapeHtml(it.date)}</span> — `
                  : "";
                const title = it?.title && it?.title !== label ? ` <span>(${escapeHtml(it.title)})</span>` : "";
                return `<li>${date}<a href=\"${escapeHtml(url)}\" target=\"_blank\" rel=\"noopener\">${escapeHtml(label)}</a>${title}</li>`;
              })
              .join("");

            const lower = String(folderName).toLowerCase();
            const isSummary = lower === "summary";
            const isFirstYear = firstYearFolderName && folderName === firstYearFolderName;
            const openAttr = isSummary || isFirstYear ? " open" : "";

            return `
              <section style="margin-top: 18px;">
                <details${openAttr}>
                  <summary style="cursor: pointer; user-select: none;">
                    <span style=\"font-weight: 700;\">${escapeHtml(folderName)}</span>
                    <span style=\"color: #666; margin-left: 8px;\">(${filtered.length})</span>
                  </summary>
                  <ul style="margin-top: 10px;">${list}</ul>
                </details>
              </section>
            `;
          })
          .join("");

        content.innerHTML = folderHtml || "<p>No matching items.</p>";
        status.textContent = q ? `${totalMatched} matching item(s)` : `${totalMatched} total item(s)`;
      }

      async function main() {
        const meta = document.getElementById("meta");
        const search = document.getElementById("search");
        const status = document.getElementById("status");

        meta.textContent = "Loading…";

        let data;
        try {
          const res = await fetch("/site_data/deejay_set_collection.json", { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          data = await res.json();
        } catch (err) {
          meta.innerHTML = `<p style=\"color: #b00020;\">Failed to load JSON: ${escapeHtml(err?.message || err)}</p>`;
          status.textContent = "";
          return;
        }

        const generatedAt = data?.generated_at ? escapeHtml(data.generated_at) : "(unknown)";
        meta.innerHTML = `<div><strong>Generated:</strong> <span style=\"font-family: monospace;\">${generatedAt}</span></div>`;

        const rerender = () => renderCollection(data, search.value);
        search.addEventListener("input", rerender);
        rerender();
      }

      main();
    </script>
  </body>
</html>